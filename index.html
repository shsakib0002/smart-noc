<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmberIT NOC | Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root { --bg-dark: #0f111a; --bg-panel: #1a1d2d; --accent: #3b82f6; --text: #e2e8f0; --success: #10b981; --crit: #ef4444; }
        body { background: var(--bg-dark); color: var(--text); font-family: 'Segoe UI', sans-serif; margin:0; height:100vh; display:flex; flex-direction:column; }
        
        /* Login Overlay */
        #login-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-dark); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .login-box { background:var(--bg-panel); padding:40px; border-radius:8px; border:1px solid #333; text-align:center; width:300px; }
        input { width:90%; padding:10px; margin:10px 0; background:#000; border:1px solid #444; color:white; border-radius:4px; }
        
        /* Layout */
        header { background: #23273a; padding:15px 20px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
        .nav-tabs { display:flex; gap:20px; margin-left:40px; }
        .tab { cursor:pointer; padding:5px 10px; color:#aaa; }
        .tab.active { color:white; border-bottom:2px solid var(--accent); }
        
        /* Views */
        #view-list, #view-map { flex:1; overflow:hidden; display:none; }
        #view-list.active, #view-map.active { display:block; }
        
        /* Table */
        .table-container { height:100%; overflow-y:auto; padding:20px; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:12px; text-align:left; border-bottom:1px solid #333; }
        tr:hover { background:rgba(255,255,255,0.05); }
        
        /* Terminal */
        #terminal-panel { position:fixed; bottom:0; width:100%; height:350px; background:#111; border-top:2px solid var(--accent); display:none; grid-template-columns: 300px 1fr; }
        .term-log { background:black; color:#0f0; font-family:monospace; padding:15px; overflow-y:auto; font-size:0.9rem; border-right:1px solid #333; }
        .term-visual { padding:20px; background:var(--bg-panel); display:flex; flex-direction:column; align-items:center; justify-content:center; }
        
        /* Hop Visualizer */
        .hop-container { display:flex; align-items:center; gap:20px; margin-top:20px; }
        .hop-node { width:80px; height:80px; border-radius:8px; background:#333; display:flex; flex-direction:column; align-items:center; justify-content:center; border:2px solid #555; position:relative; }
        .hop-line { width:50px; height:4px; background:#333; }
        .node-label { font-size:0.8rem; color:#aaa; margin-bottom:5px; }
        .node-ip { font-size:0.75rem; color:white; }
        .status-dot { width:12px; height:12px; border-radius:50%; margin-top:5px; background:#555; }
        
        .success { border-color:var(--success); } .success .status-dot { background:var(--success); } .success .hop-line { background:var(--success); }
        .fail { border-color:var(--crit); } .fail .status-dot { background:var(--crit); }
        
        .badge { padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold; }
        .badge-UP { background:rgba(16,185,129,0.2); color:var(--success); }
        .badge-DOWN { background:rgba(239,68,68,0.2); color:var(--crit); }
    </style>
</head>
<body>

{% if login_mode %}
<div id="login-overlay">
    <form class="login-box" method="POST" action="/login">
        <h2 style="color:var(--accent)">NOC Secure Login</h2>
        {% if error %}<div style="color:red; margin-bottom:10px">{{error}}</div>{% endif %}
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit" style="background:var(--accent); color:white; border:none; padding:10px 20px; width:100%; cursor:pointer; margin-top:10px;">ENTER</button>
    </form>
</div>
{% else %}

<header>
    <div style="display:flex; align-items:center;">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/></svg>
        <span style="margin-left:10px; font-weight:bold;">AmberIT NOC</span>
        <div class="nav-tabs">
            <div class="tab active" onclick="switchView('list')">List View</div>
            <div class="tab" onclick="switchView('map')">Live Map</div>
        </div>
    </div>
    <a href="/logout" style="color:#aaa; text-decoration:none; font-size:0.9rem;">Logout</a>
</header>

<div id="view-list" class="active table-container">
    <div style="max-width:1200px; margin:0 auto;">
        <h2 style="border-bottom:1px solid #333; padding-bottom:10px;">Network Inventory</h2>
        <table>
            <thead><tr><th>ID</th><th>Name</th><th>POP</th><th>Target IP</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="inventory-body"><tr><td colspan="6">Loading...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="view-map" style="height:100%;">
    <div id="map" style="width:100%; height:100%;"></div>
</div>

<div id="terminal-panel">
    <div class="term-log" id="term-log">
        > System Ready...
    </div>
    <div class="term-visual">
        <h3 id="term-title">Diagnostic: Idle</h3>
        <div class="hop-container" id="hop-viz">
            </div>
        <div id="snmp-stats" style="margin-top:20px; font-family:monospace; color:#aaa;"></div>
        <button onclick="closeTerm()" style="margin-top:20px; background:none; border:1px solid #555; color:#aaa; padding:5px 15px; cursor:pointer;">Close Terminal</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // --- GLOBAL STATE ---
    let map = null;

    // --- VIEW SWITCHER ---
    function switchView(view) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab')[view==='list'?0:1].classList.add('active');
        document.getElementById('view-list').classList.remove('active');
        document.getElementById('view-map').classList.remove('active');
        document.getElementById('view-'+view).classList.add('active');
        
        if(view === 'map' && !map) initMap();
    }

    // --- DATA LOADING ---
    async function loadData() {
        const res = await fetch('/api/inventory');
        const data = await res.json();
        
        // Render List
        const tbody = document.getElementById('inventory-body');
        tbody.innerHTML = '';
        data.forEach(link => {
            tbody.innerHTML += `
                <tr>
                    <td>${link.id}</td>
                    <td><b>${link.name}</b></td>
                    <td>${link.pop}</td>
                    <td>${link.client_ip}</td>
                    <td><span class="badge badge-${link.status}">${link.status}</span></td>
                    <td><button onclick="runDiag(${link.id}, '${link.name}')" style="background:var(--accent); border:none; color:white; padding:5px 10px; cursor:pointer; border-radius:4px;">Scan</button></td>
                </tr>
            `;
        });

        // Add to Map (Random locations around Dhaka for demo, as DB lacks coords)
        if(map) {
            data.forEach(link => {
                // Mocking coordinates near Dhaka for visualization
                // In real version, you'd pull link.lat/lng
                const lat = 23.8 + (Math.random() * 0.1 - 0.05);
                const lng = 90.4 + (Math.random() * 0.1 - 0.05);
                L.marker([lat, lng])
                 .addTo(map)
                 .bindPopup(`<b>${link.name}</b><br>Status: ${link.status}`);
            });
        }
    }

    // --- MAP INIT ---
    function initMap() {
        map = L.map('map').setView([23.8103, 90.4125], 12); // Dhaka Center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            className: 'map-tiles'
        }).addTo(map);
        // Dark mode filter for map
        document.querySelector('.leaflet-layer').style.filter = "invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%)";
        loadData(); // Reload markers
    }

    // --- TERMINAL & DIAGNOSTICS ---
    async function runDiag(id, name) {
        const panel = document.getElementById('terminal-panel');
        const log = document.getElementById('term-log');
        const viz = document.getElementById('hop-viz');
        
        panel.style.display = 'grid';
        document.getElementById('term-title').innerText = `Scanning: ${name}`;
        
        // Reset Visuals
        log.innerHTML = `> Initializing Triple-Hop Scan...<br>`;
        viz.innerHTML = '<div style="color:#aaa">Pinging Nodes...</div>';
        
        try {
            const res = await fetch(`/api/scan/${id}`, { method: 'POST' });
            const data = await res.json();
            
            // Build Visualization
            viz.innerHTML = '';
            
            data.hops.forEach((hop, index) => {
                const isUp = hop.loss === 0;
                const colorClass = isUp ? 'success' : 'fail';
                
                log.innerHTML += `> ${hop.label} (${hop.ip}): ${isUp ? 'REPLY time='+hop.latency+'ms' : 'TIMEOUT'}<br>`;
                
                // Add Node UI
                viz.innerHTML += `
                    <div class="hop-node ${colorClass}">
                        <div class="node-label">${hop.label}</div>
                        <div class="node-ip">${hop.ip}</div>
                        <div class="status-dot"></div>
                    </div>
                `;
                
                // Add Connection Line (except last)
                if(index < data.hops.length - 1) {
                    viz.innerHTML += `<div class="hop-line" style="background:${isUp ? 'var(--success)' : '#333'}"></div>`;
                }
            });
            
            log.innerHTML += `> SNMP RSSI Check: ${data.snmp.rssi || 'N/A'} dBm<br>`;
            log.innerHTML += `> <b>FINAL STATUS: ${data.status}</b><br>`;
            log.scrollTop = log.scrollHeight;
            
            document.getElementById('snmp-stats').innerHTML = `Signal Strength: <span style="color:${data.snmp.rssi < -75 ? 'orange':'#10b981'}">${data.snmp.rssi} dBm</span>`;

        } catch (e) {
            log.innerHTML += `> ERROR: Connection Failed.`;
        }
    }

    function closeTerm() {
        document.getElementById('terminal-panel').style.display = 'none';
    }

    // Start
    loadData();
</script>
{% endif %}
</body>
</html>
