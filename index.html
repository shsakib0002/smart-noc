<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmberIT NOC | Live Production</title>
    <style>
        :root { --bg-dark: #0f111a; --bg-panel: #1a1d2d; --accent: #3b82f6; --text-main: #e2e8f0; --success: #10b981; --warning: #f59e0b; --critical: #ef4444; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        header { background: #23273a; padding: 15px; border-bottom: 1px solid #334155; font-weight: bold; font-size: 1.2rem; display:flex; justify-content:space-between; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px; }
        .card { background: var(--bg-panel); padding: 20px; border-radius: 8px; border: 1px solid #334155; }
        .stat-val { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #334155; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-UP, .badge-OPTIMAL { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-DEGRADED { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-DOWN, .badge-CRITICAL { background: rgba(239, 68, 68, 0.2); color: var(--critical); }
        .badge-UNKNOWN { background: rgba(255,255,255,0.1); color: #aaa; }
        .btn { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #2563eb; }
        #diag-panel { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1d2d; border-top: 2px solid var(--accent); padding: 20px; display: none; height: 300px; overflow: hidden; }
        .terminal { background: black; color: #0f0; font-family: monospace; padding: 10px; height: 200px; overflow-y: auto; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <div>AmberIT <span>NOC Core</span></div>
    <div style="font-size:0.9rem; color:#aaa">System: <span style="color:#10b981">ONLINE</span></div>
</header>

<div class="grid">
    <div class="card"><div>Total Links</div><div class="stat-val" id="total">0</div></div>
    <div class="card"><div>Critical</div><div class="stat-val" style="color:var(--critical)" id="critical">0</div></div>
    <div class="card"><div>Degraded</div><div class="stat-val" style="color:var(--warning)" id="degraded">0</div></div>
    <div class="card"><div>Optimal</div><div class="stat-val" style="color:var(--success)" id="optimal">0</div></div>
</div>

<div style="padding: 0 20px; flex: 1; overflow-y: auto;">
    <div class="card">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between;">
            <h3>Live Network Inventory</h3>
            <button class="btn" onclick="fetchInventory()">Refresh Data</button>
        </div>
        <table>
            <thead><tr><th>ID</th><th>Name</th><th>POP</th><th>IP</th><th>Model</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="table-body">
                <tr><td colspan="7">Loading data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="diag-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <h3>Active Diagnostics</h3>
        <button class="btn" onclick="document.getElementById('diag-panel').style.display='none'">Close</button>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div class="terminal" id="console">Waiting for command...</div>
        <div id="result-view" style="padding:10px; background: rgba(0,0,0,0.2);">Select a link to scan.</div>
    </div>
</div>

<script>
    let inventoryData = [];

    // 1. Fetch Data from Python Backend
    async function fetchInventory() {
        try {
            const res = await fetch('/api/inventory');
            inventoryData = await res.json();
            renderTable();
            updateStats();
        } catch (err) {
            console.error("API Error", err);
            document.getElementById('table-body').innerHTML = '<tr><td colspan="7" style="color:red">Error connecting to Backend. Ensure app.py is running.</td></tr>';
        }
    }

    // 2. Render Table
    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        inventoryData.forEach(link => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${link.id}</td>
                <td><b>${link.name || 'N/A'}</b><div style="font-size:0.8em; color:#aaa">${link.ssid || ''}</div></td>
                <td>${link.pop || '-'}</td>
                <td>${link.client_ip}</td>
                <td>${link.model || link.vendor}</td>
                <td><span class="badge badge-${link.status}">${link.status}</span></td>
                <td><button class="btn" onclick="runDiagnostics(${link.id})">Scan Live</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 3. Update Stats
    function updateStats() {
        document.getElementById('total').innerText = inventoryData.length;
        document.getElementById('critical').innerText = inventoryData.filter(i => i.status === 'DOWN').length;
        document.getElementById('degraded').innerText = inventoryData.filter(i => i.status === 'DEGRADED').length;
        document.getElementById('optimal').innerText = inventoryData.filter(i => i.status === 'UP').length;
    }

    // 4. Run Live Diagnostics
    async function runDiagnostics(id) {
        const panel = document.getElementById('diag-panel');
        const cons = document.getElementById('console');
        const resView = document.getElementById('result-view');
        
        panel.style.display = 'block';
        cons.innerHTML = `> Initializing scan for Link ID ${id}...\n`;
        resView.innerHTML = '<div style="color:yellow">Scanning...</div>';

        try {
            const res = await fetch(`/api/scan/${id}`, { method: 'POST' });
            const data = await res.json();
            
            // Console Output
            cons.innerHTML += `> Pinging Target...\n`;
            cons.innerHTML += `> Latency: ${data.ping.latency}ms, Loss: ${data.ping.loss}%\n`;
            if(data.ping.loss === 0) {
                cons.innerHTML += `> Fetching SNMP Data...\n`;
                cons.innerHTML += `> RSSI: ${data.snmp.rssi} dBm\n`;
            } else {
                cons.innerHTML += `> ERROR: Target Unreachable. SNMP skipped.\n`;
            }
            cons.innerHTML += `> Status: ${data.status}\n`;

            // GUI Output
            resView.innerHTML = `
                <h2 style="color:${data.status==='UP'?'var(--success)':'var(--critical)'}">${data.status}</h2>
                <div style="margin-top:10px">
                    <div><b>Packet Loss:</b> ${data.ping.loss}%</div>
                    <div><b>Latency:</b> ${data.ping.latency}ms</div>
                    <div><b>Signal (RSSI):</b> ${data.snmp.rssi || 'N/A'} dBm</div>
                </div>
            `;
            
            // Refresh main table to show new status
            fetchInventory(); 

        } catch (err) {
            cons.innerHTML += `> FATAL ERROR: ${err.message}`;
        }
    }

    // Load on start
    window.onload = fetchInventory;
</script>

</body>
</html>
