<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart NOC | Client Inventory</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="config.js"></script>
    <style>
        :root {
            --bg-dark: #09090b;       
            --bg-card: #18181b;       
            --bg-panel: #101012;
            --border: #27272a;        
            --primary: #6366f1;       
            --text-main: #e4e4e7;     
            --text-muted: #a1a1aa;    
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- LAYOUT & HEADER --- */
        .layout { display: flex; height: 100%; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 24px 40px; overflow: hidden; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .branding { display: flex; align-items: center; gap: 12px; font-size: 1.5rem; font-weight: 600; color: white; }
        .branding i { color: var(--primary); }

        .actions { display: flex; gap: 15px; }
        .search-container { position: relative; width: 350px; }
        .search-input {
            width: 100%; background: var(--bg-card); border: 1px solid var(--border);
            padding: 12px 15px 12px 45px; border-radius: 8px; color: white;
            font-family: 'Outfit', sans-serif; outline: none; transition: 0.2s;
        }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .btn {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main);
            padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { background: #27272a; border-color: var(--text-muted); }
        
        .btn-inspect {
            background: rgba(99, 102, 241, 0.1); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 6px 18px; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: 0.2s;
        }
        .btn-inspect:hover { background: rgba(99, 102, 241, 0.25); color: white; }

        /* --- MAIN TABLE --- */
        .table-wrapper {
            flex: 1; overflow-y: auto; border: 1px solid var(--border);
            border-radius: 12px; background: var(--bg-card);
        }
        table { width: 100%; border-collapse: collapse; }
        thead { position: sticky; top: 0; background: #131316; z-index: 10; border-bottom: 1px solid var(--border); }
        th {
            text-align: left; padding: 18px 24px; font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);
        }
        td { padding: 18px 24px; font-size: 0.95rem; border-bottom: 1px solid var(--border); color: var(--text-main); }
        tbody tr:hover { background: rgba(255,255,255,0.03); }
        .font-mono { font-family: 'JetBrains Mono', monospace; color: #d4d4d8; font-size: 0.9rem; }

        /* --- DIAGNOSTICS SLIDE PANEL --- */
        .slide-panel {
            position: fixed; top: 0; right: -700px; width: 700px; height: 100%;
            background: var(--bg-panel); border-left: 1px solid var(--border); z-index: 1000;
            transition: right 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -20px 0 50px rgba(0,0,0,0.6); display: flex; flex-direction: column;
        }
        .slide-panel.open { right: 0; }
        
        .panel-header {
            padding: 25px 30px; border-bottom: 1px solid var(--border); background: #0c0c0e;
            display: flex; justify-content: space-between; align-items: start;
        }
        .panel-title h2 { font-size: 1.4rem; font-weight: 600; color: white; margin-bottom: 5px; }
        .panel-title span { font-family: 'JetBrains Mono'; color: var(--primary); font-size: 0.95rem; }
        
        .panel-content { padding: 30px; overflow-y: auto; flex: 1; }

        /* --- INFO SECTIONS --- */
        .info-section { margin-bottom: 30px; }
        .section-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
            font-size: 0.85rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); letter-spacing: 0.05em;
        }
        .section-header i { color: var(--primary); }
        
        .info-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
        }
        .info-item {
            background: #1c1c1f; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);
        }
        .info-label { font-size: 0.75rem; color: #71717a; margin-bottom: 4px; }
        .info-value { font-size: 0.95rem; font-weight: 500; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- DIAGNOSTICS AREA --- */
        .diag-box {
            background: #131316; border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-top: 20px;
        }
        .btn-run {
            width: 100%; padding: 14px; background: var(--primary); color: white; border: none;
            border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 10px; transition: 0.2s; font-size: 1rem;
        }
        .btn-run:hover { background: #4f46e5; }
        .btn-run:disabled { opacity: 0.6; cursor: not-allowed; }

        .topology-map {
            display: flex; align-items: center; justify-content: space-between; margin: 30px 20px; position: relative;
        }
        .topology-line {
            position: absolute; top: 50%; left: 30px; right: 30px; height: 2px; background: #333; z-index: 0;
        }
        .node {
            width: 50px; height: 50px; background: #18181b; border: 2px solid #333;
            border-radius: 10px; z-index: 1; display: flex; align-items: center; justify-content: center;
            color: #555; transition: 0.3s;
        }
        .node.up { border-color: var(--success); color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .node.down { border-color: var(--danger); color: var(--danger); }
        
        .status-result { text-align: center; margin-top: 20px; }
        .status-text { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
        
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="layout">
        <div class="main-content">
            
            <div class="header">
                <div class="branding">
                    <i data-lucide="radio-tower"></i>
                    <span>Smart NOC</span>
                </div>
                
                <div class="actions">
                    <div class="search-container">
                        <i data-lucide="search" class="search-icon" width="16"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search Client, IP, Location..." oninput="filterTable()">
                    </div>
                    <button class="btn" onclick="document.getElementById('csvInput').click()">
                        <i data-lucide="upload-cloud" width="16"></i>
                        Import CSV
                    </button>
                    <input type="file" id="csvInput" hidden accept=".csv">
                </div>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 25%;">Client Name</th>
                            <th style="width: 15%;">IP Address</th>
                            <th style="width: 20%;">Base Station</th>
                            <th style="width: 20%;">Location</th>
                            <th style="width: 10%;">District</th>
                            <th style="text-align: right; width: 10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);"><i data-lucide="loader-2" class="spin"></i> Loading Database...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <div id="diagPanel" class="slide-panel">
        <div class="panel-header">
            <div class="panel-title">
                <h2 id="p-name">Client Name</h2>
                <span id="p-ip">0.0.0.0</span>
            </div>
            <button onclick="closePanel()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; padding: 5px;">
                <i data-lucide="x" width="24"></i>
            </button>
        </div>
        
        <div class="panel-content">
            
            <div class="info-section">
                <div class="section-header"><i data-lucide="map-pin"></i> Location & Identity</div>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">Link ID / SL</div><div class="info-value font-mono" id="p-sl">--</div></div>
                    <div class="info-item"><div class="info-label">POP Name</div><div class="info-value" id="p-pop">--</div></div>
                    <div class="info-item"><div class="info-label">Location / Branch</div><div class="info-value" id="p-loc">--</div></div>
                    <div class="info-item"><div class="info-label">District</div><div class="info-value" id="p-dist">--</div></div>
                </div>
            </div>

            <div class="info-section">
                <div class="section-header"><i data-lucide="cpu"></i> Device Configuration</div>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">Radio Model</div><div class="info-value" id="p-model">--</div></div>
                    <div class="info-item"><div class="info-label">Device Mode</div><div class="info-value" id="p-mode">--</div></div>
                    <div class="info-item"><div class="info-label">Connection Type</div><div class="info-value" id="p-conn">--</div></div>
                    <div class="info-item"><div class="info-label">Link Type</div><div class="info-value" id="p-linktype">--</div></div>
                </div>
            </div>

            <div class="info-section">
                <div class="section-header"><i data-lucide="wifi"></i> RF & Network Parameters</div>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">BTS Name</div><div class="info-value" id="p-bts-name">--</div></div>
                    <div class="info-item"><div class="info-label">BTS IP</div><div class="info-value font-mono" id="p-bts-ip">--</div></div>
                    <div class="info-item"><div class="info-label">SSID</div><div class="info-value font-mono" id="p-ssid">--</div></div>
                    <div class="info-item"><div class="info-label">Frequency</div><div class="info-value" id="p-freq">--</div></div>
                    <div class="info-item"><div class="info-label">Channel</div><div class="info-value" id="p-chan">--</div></div>
                    <div class="info-item"><div class="info-label">Signal (RSSI)</div><div class="info-value" id="p-rssi">--</div></div>
                    <div class="info-item" style="grid-column: span 2;"><div class="info-label">Gateway IP</div><div class="info-value font-mono" id="p-gw">--</div></div>
                </div>
            </div>

            <div class="diag-box">
                <button class="btn-run" id="btnRun" onclick="runDiagnostics()">
                    <i data-lucide="play"></i> Run Live Diagnostics
                </button>
                
                <div id="resultsArea" style="display: none;">
                    <div class="topology-map">
                        <div class="topology-line"></div>
                        <div class="node" id="n-gw" title="Gateway"><i data-lucide="server"></i></div>
                        <div class="node" id="n-base" title="Base Station"><i data-lucide="router"></i></div>
                        <div class="node" id="n-client" title="Client Radio"><i data-lucide="wifi"></i></div>
                    </div>
                    <div class="status-result">
                        <div class="status-text" id="res-status">--</div>
                        <div style="color: #a1a1aa; font-size: 0.9rem;" id="res-cause">--</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = window.API_BASE || window.location.origin;
        console.log("Connected to:", API_BASE);
        
        let inventoryData = [];
        let currentClient = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadInventory();
        });

        async function loadInventory() {
            try {
                const res = await fetch(`${API_BASE}/api/inventory`);
                if (!res.ok) throw new Error("Fetch Failed");
                inventoryData = await res.json();
                renderTable(inventoryData);
            } catch (e) {
                console.error(e);
                document.getElementById('inventoryTable').innerHTML = `<tr><td colspan="6" style="text-align:center; color:#ef4444; padding:20px;">Connection Error. Check Backend.</td></tr>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('inventoryTable');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: #555;">No Data Found. Import CSV.</td></tr>`;
                return;
            }
            
            tbody.innerHTML = data.map((item, index) => `
                <tr>
                    <td style="font-weight: 500; color: white;">${item.Link_Name || item.Client_Name || 'Unknown'}</td>
                    <td class="font-mono">${item.Client_IP || '--'}</td>
                    <td class="font-mono">${item.BTS_Name || item.Base_IP || item.BTS_IP || '--'}</td>
                    <td>${item.Location_Branch || item.Location || '--'}</td>
                    <td>${item.District || '--'}</td>
                    <td style="text-align: right;">
                        <button class="btn-inspect" onclick='openPanel(${index})'>Inspect</button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = inventoryData.filter(item => 
                (item.Link_Name && item.Link_Name.toLowerCase().includes(term)) ||
                (item.Client_IP && item.Client_IP.includes(term)) ||
                (item.BTS_Name && item.BTS_Name.toLowerCase().includes(term)) ||
                (item.Location_Branch && item.Location_Branch.toLowerCase().includes(term))
            );
            renderTable(filtered);
        }

        function openPanel(index) {
            currentClient = inventoryData[index];
            document.getElementById('diagPanel').classList.add('open');

            // --- POPULATE DATA ---
            // Identity
            setText('p-name', currentClient.Link_Name || currentClient.Client_Name);
            setText('p-ip', currentClient.Client_IP);
            setText('p-sl', currentClient.SL || currentClient.Link_ID);
            setText('p-pop', currentClient.POP_Name);
            setText('p-loc', currentClient.Location_Branch || currentClient.Location);
            setText('p-dist', currentClient.District);

            // Device
            setText('p-model', currentClient.Radio_Model || currentClient.Device_Model);
            setText('p-mode', currentClient.Device_Mode);
            setText('p-conn', currentClient.Connection_Type);
            setText('p-linktype', currentClient.Link_Type);

            // RF
            setText('p-bts-name', currentClient.BTS_Name || 'N/A');
            setText('p-bts-ip', currentClient.BTS_IP || currentClient.Base_IP);
            setText('p-ssid', currentClient.SSID);
            setText('p-freq', (currentClient.Frequency_Used || '') + ' ' + (currentClient.Frequency_Type || ''));
            setText('p-chan', currentClient.Channel);
            setText('p-rssi', currentClient.RSSI);
            setText('p-gw', currentClient.Gateway_IP || 'Calculating...');

            // Reset Diagnostics UI
            document.getElementById('resultsArea').style.display = 'none';
            const btn = document.getElementById('btnRun');
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="play"></i> Run Live Diagnostics`;
            lucide.createIcons();
        }

        function setText(id, val) {
            document.getElementById(id).innerText = (val && val !== "N/A" && val !== "") ? val : "--";
        }

        function closePanel() {
            document.getElementById('diagPanel').classList.remove('open');
        }

        async function runDiagnostics() {
            if (!currentClient) return;
            const btn = document.getElementById('btnRun');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="spin"></i> Diagnosing...`;
            lucide.createIcons();

            try {
                const res = await fetch(`${API_BASE}/api/diagnose`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ip: currentClient.Client_IP })
                });
                const data = await res.json();
                
                document.getElementById('resultsArea').style.display = 'block';
                const statusEl = document.getElementById('res-status');
                statusEl.innerText = data.final_status;
                
                // Color Logic
                statusEl.style.color = data.final_status.includes('UP') ? '#10b981' : (data.final_status.includes('UNSTABLE') ? '#f59e0b' : '#ef4444');
                document.getElementById('res-cause').innerText = data.cause;

                setNode('n-client', data.topology?.client?.status);
                setNode('n-base', data.topology?.base?.status);
                setNode('n-gw', data.topology?.gw?.status);

            } catch (e) {
                alert("Diagnostics Failed: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="rotate-cw"></i> Re-Run Test`;
                lucide.createIcons();
            }
        }

        function setNode(id, status) {
            const el = document.getElementById(id);
            el.className = 'node';
            if (status === 'UP') el.classList.add('up');
            else if (status === 'DOWN') el.classList.add('down');
        }

        // Import
        document.getElementById('csvInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const text = ev.target.result;
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                // Basic CSV Parser (assuming standard format, skipping header)
                const payload = lines.slice(1).map(line => {
                    const c = line.split(','); 
                    if(c.length < 5) return null;
                    return {
                        "Client_Name": c[1], "Client_IP": c[5], "Base_IP": c[4],
                        "Location": c[2], "Link_ID": c[0]
                        // Note: A real CSV parser handles quotes better, 
                        // but this works for standard simple CSVs
                    };
                }).filter(x => x);

                await fetch(`${API_BASE}/api/inventory`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                alert("Imported!");
                loadInventory();
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
