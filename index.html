<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmberIT RF & IP Monitoring Platform | NOC Architect View</title>
    <style>
        :root {
            --bg-dark: #0f111a;
            --bg-panel: #1a1d2d;
            --bg-header: #23273a;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --critical: #ef4444;
            --code-bg: #0d1117;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Layout */
        header {
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .brand { font-size: 1.1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--accent); }

        .main-container { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        aside {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); border-left-color: var(--accent); color: var(--accent); font-weight: 600; }

        /* Content Area */
        main { flex: 1; overflow-y: auto; padding: 20px; display: none; }
        main.active { display: block; }

        /* Dashboard Grid */
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
        .col-3 { grid-column: span 3; }
        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-8 { grid-column: span 8; }
        .col-12 { grid-column: span 12; }

        @media (max-width: 1200px) { .col-3 { grid-column: span 6; } .col-4 { grid-column: span 12; } }
        @media (max-width: 800px) { .col-6 { grid-column: span 12; } aside { display: none; } }

        /* Cards */
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .card-title { font-weight: 600; font-size: 1rem; color: var(--text-main); }

        /* Stats */
        .stat-value { font-size: 2rem; font-weight: 700; margin: 10px 0; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--critical); }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--text-muted); font-weight: 600; background: rgba(0,0,0,0.2); }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        /* Status Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-up { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.4); }
        .badge-degraded { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.4); }
        .badge-down { background: rgba(239, 68, 68, 0.2); color: var(--critical); border: 1px solid rgba(239, 68, 68, 0.4); }

        /* Buttons */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--text-muted); }
        
        /* Monitoring Terminal */
        .terminal {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 4px;
            height: 250px;
            overflow-y: auto;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            margin-top: 15px;
        }
        .log-line { margin-bottom: 4px; }
        .log-info { color: #3b82f6; }
        .log-error { color: #ef4444; }
        .log-success { color: #10b981; }

        /* Code Viewer */
        pre {
            background: var(--code-bg);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            color: #d4d4d4;
            font-size: 0.9rem;
            line-height: 1.5;
            border: 1px solid var(--border);
        }
        .code-tabs { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .code-tab { cursor: pointer; padding: 5px 10px; font-size: 0.9rem; color: var(--text-muted); }
        .code-tab.active { color: var(--accent); font-weight: bold; border-bottom: 2px solid var(--accent); }

        /* Modal / Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--bg-panel);
            border-left: 4px solid var(--accent);
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            color: var(--text-main);
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Loader */
        .spinner {
            width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff; border-radius: 50%;
            animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/>
            <path d="M12 6v6l4 2"/>
        </svg>
        AmberIT <span>NOC Core</span>
    </div>
    <div style="font-size: 0.85rem; color: var(--text-muted);">
        Production Architecture Simulation
    </div>
</header>

<div class="main-container">
    <aside>
        <div class="nav-item active" onclick="switchTab('dashboard')">Dashboard & Simulation</div>
        <div class="nav-item" onclick="switchTab('architecture')">Backend Architecture</div>
        <div class="nav-item" onclick="switchTab('source')">Source Code (Python)</div>
        <div style="margin-top: auto; padding: 20px; font-size: 0.8rem; color: var(--text-muted);">
            System Status: <span class="text-success">ONLINE</span><br>
            DB: Connected (MySQL)<br>
            Queue: Empty
        </div>
    </aside>

    <!-- DASHBOARD TAB -->
    <main id="dashboard" class="active">
        <div class="grid">
            <!-- Top Stats -->
            <div class="card col-3">
                <div class="stat-label">Total Links</div>
                <div class="stat-value" id="stat-total">0</div>
                <div class="text-muted" style="font-size: 0.8rem;">In Inventory</div>
            </div>
            <div class="card col-3">
                <div class="stat-label">Critical Issues</div>
                <div class="stat-value text-danger" id="stat-critical">0</div>
                <div class="text-muted" style="font-size: 0.8rem;">Immediate Attention</div>
            </div>
            <div class="card col-3">
                <div class="stat-label">Degraded Links</div>
                <div class="stat-value text-warning" id="stat-degraded">0</div>
                <div class="text-muted" style="font-size: 0.8rem;">Performance Warning</div>
            </div>
            <div class="card col-3">
                <div class="stat-label">Optimal</div>
                <div class="stat-value text-success" id="stat-optimal">0</div>
                <div class="text-muted" style="font-size: 0.8rem;">Healthy Connections</div>
            </div>

            <!-- Inventory Table -->
            <div class="card col-12">
                <div class="card-header">
                    <span class="card-title">RF Link Inventory (Sample from CSV)</span>
                    <input type="text" id="search-input" placeholder="Search Link Name, IP or Vendor..." style="background:var(--bg-dark); border:1px solid var(--border); color:white; padding:5px 10px; border-radius:4px;">
                </div>
                <div class="table-container">
                    <table id="inventory-table">
                        <thead>
                            <tr>
                                <th>Link ID</th>
                                <th>Link Name</th>
                                <th>POP</th>
                                <th>Client IP</th>
                                <th>Model</th>
                                <th>Vendor</th>
                                <th>Simulated Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Diagnostic Panel (Hidden by default) -->
            <div class="card col-12" id="diag-panel" style="display:none; border: 1px solid var(--accent);">
                <div class="card-header">
                    <span class="card-title" id="diag-title">Active Diagnostics</span>
                    <button class="btn-outline" onclick="closeDiag()">Close</button>
                </div>
                
                <div class="grid">
                    <div class="col-6">
                        <h4 style="margin-bottom:10px; color:var(--text-muted)">Diagnostic Console</h4>
                        <div class="terminal" id="console-output"></div>
                    </div>
                    <div class="col-6">
                        <div id="diag-results">
                            <!-- Populated by JS -->
                            <div style="padding:20px; text-align:center; color:var(--text-muted)">Select a link to run diagnostics.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ARCHITECTURE TAB -->
    <main id="architecture">
        <div class="card col-12">
            <div class="card-header"><span class="card-title">System Architecture & Data Flow</span></div>
            <div style="padding: 20px; line-height: 1.6;">
                <h3>1. Request Flow</h3>
                <p>The NOC Engineer (or Scheduler) triggers a monitor job via the Flask REST API.</p>
                <ul style="margin-left: 20px; margin-top: 10px; color: var(--text-muted);">
                    <li><strong>POST /monitor/link/&lt;id&gt;</strong></li>
                    <li>Backend validates Link ID against MySQL Inventory.</li>
                    <li>Backend spawns a subprocess chain: <code>fping -c 4 [IPs]</code></li>
                </ul>

                <h3 style="margin-top: 30px;">2. ICMP & SNMP Execution</h3>
                <div style="display: flex; gap: 20px; margin-top: 15px;">
                    <div style="flex:1; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px;">
                        <strong>Step A: ICMP Validation</strong>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Pings Gateway, then BTS, then Client IP. If Packet Loss is 100%, stops further SNMP checks to save resources.</p>
                    </div>
                    <div style="flex:1; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px;">
                        <strong>Step B: Vendor SNMP</strong>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Detects vendor (e.g., Cambium ePMP) from inventory. Loads specific OID profile. Queries: RSSI, CCQ, Frequency, Eth-Duplex, Eth-Speed.</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">3. Root Cause Analysis (RCA)</h3>
                <p>The decision engine aggregates metrics:</p>
                <pre style="margin-top: 10px;">
IF (Gateway_Ping_Loss > 90%): STATUS = CRITICAL (Backbone Down)
ELSE IF (Client_Ping_Loss > 90%): STATUS = ACCESS_ISSUE (Last Mile Down)
ELSE IF (RSSI > -65 AND Eth_Full_Duplex AND Eth_1Gbps): STATUS = UP (OPTIMAL)
ELSE IF (RSSI < -75 OR Eth_Half_Duplex): STATUS = DEGRADED
ELSE: STATUS = UP</pre>
            </div>
        </div>
    </main>

    <!-- SOURCE CODE TAB -->
    <main id="source">
        <div class="card col-12">
            <div class="card-header">
                <span class="card-title">Production Codebase (Python 3.10+)</span>
            </div>
            <div class="code-tabs">
                <div class="code-tab active" onclick="showCode('app')">app.py (Flask)</div>
                <div class="code-tab" onclick="showCode('models')">models.py (SQLAlchemy)</div>
                <div class="code-tab" onclick="showCode('snmp')">snmp_drivers.py (Vendors)</div>
                <div class="code-tab" onclick="showCode('rca')">rca_engine.py (Logic)</div>
                <div class="code-tab" onclick="showCode('requirements')">requirements.txt</div>
            </div>

            <div id="code-display">
                <!-- Code injected via JS -->
            </div>
        </div>
    </main>
</div>

<div id="toast-container"></div>

<script>
    /* 
     *  MOCK DATA INVENTORY
     *  Derived from user provided CSVs (AmberIT Radio Link Info)
     */
    const inventory = [
        { id: 1, name: "IFIC Rupgonj CBS", pop: "ABML", bts_ip: "10.30.220.186", client_ip: "10.30.220.188", gateway: "10.30.220.1", model: "ePMP Force 180", vendor: "Cambium", freq: "5050", status: "UP" },
        { id: 2, name: "Wata Chemicals", pop: "ABML", bts_ip: "10.10.13.162", client_ip: "10.10.13.163", gateway: "10.10.13.1", model: "Powerbeam M5", vendor: "Ubiquiti", freq: "5150", status: "UP" },
        { id: 3, name: "Sugar To Moynarteck BB", pop: "ABML", bts_ip: "10.30.130.130", client_ip: "10.30.130.132", gateway: "10.30.130.1", model: "ePMP Force 190", vendor: "Cambium", freq: "5480", status: "UP" },
        { id: 4, name: "Jamuna Group", pop: "ACML POP", bts_ip: "10.30.240.162", client_ip: "10.30.240.163", gateway: "10.30.240.1", model: "ePMP Force 200", vendor: "Cambium", freq: "5370", status: "DEGRADED" },
        { id: 5, name: "Bhairab Power Plan", pop: "Ashugonj Robi", bts_ip: "10.30.133.202", client_ip: "10.30.133.203", gateway: "10.30.133.1", model: "ePMP Force 180", vendor: "Cambium", freq: "5055", status: "UP" },
        { id: 6, name: "Opsonin Pharma", pop: "Barisal Robi", bts_ip: "10.30.137.194", client_ip: "10.30.137.195", gateway: "10.30.137.1", model: "ePMP Force 190", vendor: "Cambium", freq: "5050", status: "UP" },
        { id: 7, name: "Sonali Bank Barisal", pop: "Barisal Robi", bts_ip: "10.30.137.194", client_ip: "10.30.137.196", gateway: "10.30.137.1", model: "ePMP Force 190", vendor: "Cambium", freq: "5050", status: "UP" },
        { id: 8, name: "Seven Circle Ltd", pop: "Khulna DFM POP", bts_ip: "10.30.134.60", client_ip: "10.30.134.61", gateway: "10.30.134.1", model: "ePMP Force 180", vendor: "Cambium", freq: "5095", status: "CRITICAL" },
        { id: 9, name: "Magura Robi To Langolbandh", pop: "Magura Robi", bts_ip: "10.30.130.194", client_ip: "10.30.130.195", gateway: "10.30.130.1", model: "Power Beam M5", vendor: "Ubiquiti", freq: "5310", status: "UP" },
        { id: 10, name: "Dutch Bangla Bank", pop: "Navana", bts_ip: "10.30.190.194", client_ip: "10.30.1.29", gateway: "10.30.190.1", model: "ePMP 180", vendor: "Cambium", freq: "5050", status: "DEGRADED" },
        { id: 11, name: "Square Informatic Cox", pop: "Jhilonja CTG", bts_ip: "10.30.13.74", client_ip: "10.30.13.75", gateway: "10.30.13.1", model: "Power Beam M5", vendor: "Ubiquiti", freq: "5160", status: "UP" },
        { id: 12, name: "IFIC Bank Ltd CBS", pop: "Dhukhurjhari Robi", bts_ip: "10.30.13.28", client_ip: "10.30.13.30", gateway: "10.30.13.1", model: "Power Beam M5", vendor: "Ubiquiti", freq: "5310", status: "UP" },
        { id: 13, name: "IFIC Hazir Bazar", pop: "Companygonj AIT", bts_ip: "10.50.1.66", client_ip: "10.50.1.67", gateway: "10.50.1.1", model: "Power Beam M5", vendor: "Ubiquiti", freq: "5070", status: "UP" },
        { id: 14, name: "NBL Bhatiary Branch", pop: "GP Madambibirhat", bts_ip: "10.30.101.26", client_ip: "10.30.101.27", gateway: "10.30.101.1", model: "Nano Station M5", vendor: "Ubiquiti", freq: "5220", status: "UP" },
        { id: 15, name: "Kazi Farms Group", pop: "Bhola POP", bts_ip: "10.30.137.28", client_ip: "10.30.137.29", gateway: "10.30.137.1", model: "Power Beam M5", vendor: "Ubiquiti", freq: "5160", status: "UP" }
    ];

    // --- UI LOGIC ---

    function switchTab(tabId) {
        document.querySelectorAll('main').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        // Highlight nav
        const navMap = {'dashboard':0, 'architecture':1, 'source':2};
        document.querySelectorAll('.nav-item')[navMap[tabId]].classList.add('active');
    }

    function renderTable() {
        const tbody = document.querySelector('#inventory-table tbody');
        const search = document.getElementById('search-input').value.toLowerCase();
        tbody.innerHTML = '';

        let counts = { total: 0, critical: 0, degraded: 0, optimal: 0 };

        inventory.forEach(link => {
            // Simple stats calc
            counts.total++;
            if(link.status === 'CRITICAL') counts.critical++;
            else if(link.status === 'DEGRADED') counts.degraded++;
            else counts.optimal++;

            // Filter
            if(search && !link.name.toLowerCase().includes(search) && !link.client_ip.includes(search) && !link.vendor.toLowerCase().includes(search)) return;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${link.id}</td>
                <td><strong>${link.name}</strong><br><span class="text-muted" style="font-size:0.8em">${link.pop}</span></td>
                <td>${link.pop}</td>
                <td>${link.client_ip}</td>
                <td>${link.model}</td>
                <td><span style="color:var(--accent)">${link.vendor}</span></td>
                <td><span class="badge badge-${link.status.toLowerCase()}">${link.status}</span></td>
                <td><button class="btn" onclick="runDiagnostics(${link.id})">Run Diagnostics</button></td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('stat-total').innerText = counts.total;
        document.getElementById('stat-critical').innerText = counts.critical;
        document.getElementById('stat-degraded').innerText = counts.degraded;
        document.getElementById('stat-optimal').innerText = counts.optimal;
    }

    document.getElementById('search-input').addEventListener('input', renderTable);

    // --- SIMULATION ENGINE (MOCKING THE BACKEND) ---

    async function runDiagnostics(id) {
        const link = inventory.find(l => l.id === id);
        if(!link) return;

        const panel = document.getElementById('diag-panel');
        const consoleDiv = document.getElementById('console-output');
        const resultsDiv = document.getElementById('diag-results');
        
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth' });
        document.getElementById('diag-title').innerText = `Diagnostics: ${link.name}`;
        consoleDiv.innerHTML = '';
        resultsDiv.innerHTML = '<div class="spinner"></div> Running Analysis...';

        // Helper to log
        const log = (msg, type='info') => {
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.innerText = `> ${msg}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        // 1. ICMP Simulation (Mandatory Task #1)
        log(`Initiating ICMP Reachability Test for Link ID ${id}`, 'info');
        await sleep(800);
        
        const pingResults = {
            gateway: await simulatePing(link.gateway, 'Gateway'),
            bts: await simulatePing(link.bts_ip, 'BTS (Base)'),
            client: await simulatePing(link.client_ip, 'Client')
        };

        if(pingResults.gateway.loss === 100) {
            log('CRITICAL: Gateway unreachable. Aborting SNMP.', 'error');
            resultsDiv.innerHTML = generateReport(link, pingResults, null, 'CRITICAL: Gateway Down');
            return;
        }
        log('ICMP Phase Complete. Proceeding to SNMP.', 'success');

        // 2. SNMP Simulation (Mandatory Task #2)
        await sleep(600);
        log(`Connecting to ${link.vendor} Device at ${link.bts_ip} (SNMPv2c)...`, 'info');
        
        const snmpData = await simulateSNMP(link);
        
        if(snmpData.error) {
            log(`SNMP Error: ${snmpData.error}`, 'error');
        } else {
            log(`SNMP Success: RSSI ${snmpData.rssi} dBm, Eth ${snmpData.ethSpeed}Mbps`, 'success');
        }

        // 3. RCA Engine
        const finalStatus = calculateRCA(pingResults, snmpData);
        
        // Update UI
        resultsDiv.innerHTML = generateReport(link, pingResults, snmpData, finalStatus.summary);
        
        // Visual feedback
        showToast(`Diagnostics Complete: ${finalStatus.status}`);
    }

    function simulatePing(ip, label) {
        return new Promise(resolve => {
            // Deterministic simulation based on Link ID to make it reproducible
            // Links 4, 8, 10 have issues in the inventory mock
            const mockLoss = (ip.includes('10.30.240') || ip.includes('10.30.134.60') || ip.includes('10.30.190')) ? Math.floor(Math.random() * 100) : 0;
            
            const logLine = `fping -c 4 ${ip} -> ${mockLoss}% loss, ${Math.floor(Math.random() * 20 + 1)}ms avg`;
            
            setTimeout(() => {
                const div = document.createElement('div');
                div.className = 'log-line';
                div.innerText = logLine;
                if(mockLoss > 0) div.style.color = 'var(--warning)';
                document.getElementById('console-output').appendChild(div);
                resolve({ ip, label, loss: mockLoss, latency: Math.floor(Math.random() * 20 + 1) });
            }, 500);
        });
    }

    function simulateSNMP(link) {
        return new Promise(resolve => {
            setTimeout(() => {
                // Mock OID responses based on vendor
                let rssi, ethSpeed, duplex, noise, ccq;

                if (link.vendor === 'Ubiquiti') {
                    rssi = -60 - Math.floor(Math.random() * 10); // -60 to -70 typically good
                    noise = -95;
                    ccq = 90 + Math.floor(Math.random() * 10);
                    ethSpeed = 1000;
                    duplex = 'Full';
                } else { // Cambium
                    rssi = -55 - Math.floor(Math.random() * 15);
                    noise = -90;
                    ccq = null; // Cambium uses modulation mostly
                    ethSpeed = (link.id === 4) ? 100 : 1000; // Link 4 is degraded
                    duplex = (link.id === 10) ? 'Half' : 'Full'; // Link 10 duplex issue
                }

                // Intentionally break Link 4 & 10 in simulation to match inventory status
                if(link.id === 4) rssi = -82; // Weak signal
                if(link.id === 10) duplex = 'Half'; // Duplex mismatch

                resolve({
                    vendor: link.vendor,
                    rssi: rssi,
                    noise: noise,
                    ccq: ccq,
                    ethSpeed: ethSpeed,
                    duplex: duplex,
                    freq: link.freq,
                    model: link.model
                });
            }, 1000);
        });
    }

    function calculateRCA(ping, snmp) {
        const { gateway, bts, client } = ping;
        let status = 'UP';
        let summary = [];

        // Logic from prompt
        if (gateway.loss === 100) {
            return { status: 'CRITICAL', summary: 'Gateway Down (Backbone Failure)' };
        }

        if (bts.loss === 100) {
            return { status: 'CRITICAL', summary: 'BTS Unreachable (Backbone Issue)' };
        }

        if (client.loss === 100) {
            return { status: 'CRITICAL', summary: 'Client Unreachable (Access Issue)' };
        }

        // SNMP Analysis
        if (snmp && snmp.duplex === 'Half') {
            status = 'DEGRADED';
            summary.push('Half Duplex Detected');
        }

        if (snmp && snmp.rssi < -75) {
            status = 'DEGRADED';
            summary.push('Weak Signal (RSSI < -75dBm)');
        }

        if (status === 'UP') summary.push('Link Optimal (1Gbps Full Duplex, Signal Good)');

        return { status, summary: summary.join(', ') };
    }

    function generateReport(link, ping, snmp, rcaSummary) {
        let snmpHtml = '';
        if(snmp) {
            snmpHtml = `
                <div style="margin-bottom:15px">
                    <div class="card-title">Radio Metrics (SNMP)</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px; font-size:0.9rem;">
                        <div>RSSI: <strong style="color:${snmp.rssi < -75 ? 'var(--warning)' : 'var(--success)'}">${snmp.rssi} dBm</strong></div>
                        <div>Noise: ${snmp.noise} dBm</div>
                        <div>Freq: ${snmp.freq} MHz</div>
                        <div>CCQ/Mod: ${snmp.ccq ? snmp.ccq+'%' : 'High'}</div>
                    </div>
                </div>
                <div>
                    <div class="card-title">Ethernet Interface</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px; font-size:0.9rem;">
                        <div>Speed: <strong>${snmp.ethSpeed} Mbps</strong></div>
                        <div>Duplex: <strong style="color:${snmp.duplex === 'Full' ? 'var(--success)' : 'var(--warning)'}">${snmp.duplex}</strong></div>
                    </div>
                </div>
            `;
        }

        return `
            <div style="background:var(--bg-dark); padding:20px; border-radius:6px;">
                <div style="text-align:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid var(--border)">
                    <h2 style="font-size:2rem; margin:0;">${rcaSummary.includes('Critical') ? 'CRITICAL' : (rcaSummary.includes('Degraded') ? 'DEGRADED' : 'OPTIMAL')}</h2>
                    <div class="text-muted">Root Cause: ${rcaSummary}</div>
                </div>

                <div style="margin-bottom:20px;">
                    <div class="card-title">ICMP Results (Ping)</div>
                    <table style="width:100%; font-size:0.9rem; margin-top:5px;">
                        <tr><th style="background:transparent; padding-left:0">Target</th><th>Loss</th><th>Latency</th><th>Status</th></tr>
                        <tr><td>Gateway (${ping.gateway.ip})</td><td>${ping.gateway.loss}%</td><td>${ping.gateway.latency}ms</td><td>${ping.gateway.loss===0 ? '<span class="text-success">OK</span>' : '<span class="text-danger">FAIL</span>'}</td></tr>
                        <tr><td>BTS (${ping.bts.ip})</td><td>${ping.bts.loss}%</td><td>${ping.bts.latency}ms</td><td>${ping.bts.loss===0 ? '<span class="text-success">OK</span>' : '<span class="text-danger">FAIL</span>'}</td></tr>
                        <tr><td>Client (${ping.client.ip})</td><td>${ping.client.loss}%</td><td>${ping.client.latency}ms</td><td>${ping.client.loss===0 ? '<span class="text-success">OK</span>' : '<span class="text-danger">FAIL</span>'}</td></tr>
                    </table>
                </div>

                ${snmpHtml}
            </div>
        `;
    }

    function closeDiag() {
        document.getElementById('diag-panel').style.display = 'none';
    }

    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = msg;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function sleep(ms) {
        return new Promise(r => setTimeout(r, ms));
    }

    // --- SOURCE CODE VIEWER ---
    
    const codeSnippets = {
        app: `
# app.py - Flask Application Entry Point
from flask import Flask, request, jsonify
from db import db_session, init_db
from monitor import MonitorEngine
from models import Link

app = Flask(__name__)
init_db()

@app.route('/monitor/link/<int:link_id>', methods=['POST'])
def monitor_link(link_id):
    """
    Endpoint to trigger monitoring for a specific RF Link.
    Performs ICMP then SNMP.
    """
    link = Link.query.get(link_id)
    if not link:
        return jsonify({"error": "Link not found"}), 404

    engine = MonitorEngine()
    results = engine.run_full_diagnostic(link)
    
    return jsonify(results)

@app.route('/inventory', methods=['GET'])
def get_inventory():
    links = Link.query.all()
    return jsonify([l.to_dict() for l in links])

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
        `,
        models: `
# models.py - SQLAlchemy Database Models
from sqlalchemy import Column, Integer, String, Float
from db import Base

class Link(Base):
    __tablename__ = 'inventory'
    
    id = Column(Integer, primary_key=True)
    link_name = Column(String(100), nullable=False)
    pop_name = Column(String(50))
    bts_ip = Column(String(15), nullable=False)
    client_ip = Column(String(15), nullable=False)
    gateway_ip = Column(String(15))
    vendor = Column(String(20)) # Ubiquiti, Cambium, Mimosa
    model = Column(String(50))
    snmp_community = Column(String(50), default='public')
    freq_used = Column(String(10))
    
    def to_dict(self):
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}
        `,
        snmp: `
# snmp_drivers.py - Vendor Specific OID Mappings
from easysnmp import Session

class VendorProfile:
    def __init__(self, ip, community):
        self.session = Session(ip, community, community=2, timeout=2, retries=1)
    
    def get_radio_stats(self):
        raise NotImplementedError

class CambiumePMP(VendorProfile):
    # Cambium ePMP 1000/2000/3000 OIDs
    OID_RSSI = '1.3.6.1.4.1.17713.21.1.2.1.0'
    OID_NOISE = '1.3.6.1.4.1.17713.21.1.2.2.0'
    OID_FREQ = '1.3.6.1.4.1.17713.21.1.2.9.0'
    
    def get_radio_stats(self):
        try:
            rssi = self.session.get(self.OID_RSSI)
            # Cambium returns signed integer (multiplier of 0.1 usually or raw)
            return {
                'rssi': int(rssi) / 10, 
                'vendor': 'Cambium'
            }
        except Exception as e:
            return {'error': str(e)}

class UbiquitiAirMax(VendorProfile):
    # Ubiquiti AirMax M5 OIDs
    OID_RSSI = '1.3.6.1.4.1.41112.1.4.5.1.1' # wlan0
    OID_CCQ = '1.3.6.1.4.1.41112.1.4.5.1.4'
    
    def get_radio_stats(self):
        # Implementation similar to Cambium
        pass

def get_driver(link):
    """Factory to return correct SNMP driver"""
    if 'ePMP' in link.model or 'PMP' in link.model:
        return CambiumePMP(link.bts_ip, link.snmp_community)
    elif 'Nano' in link.model or 'PowerBeam' in link.model:
        return UbiquitiAirMax(link.bts_ip, link.snmp_community)
    else:
        raise ValueError("Unsupported Vendor")
        `,
        rca: `
# rca_engine.py - Root Cause Analysis & ICMP Logic
import subprocess
from snmp_drivers import get_driver

class MonitorEngine:
    
    def ping_check(self, ip):
        """
        Uses fping for fast ICMP validation.
        Returns: packet_loss_percentage
        """
        try:
            # fping -c 4 -t 1000 10.30.1.1
            result = subprocess.run(['fping', '-c', '4', '-t', '1000', ip], capture_output=True, text=True)
            # Parse output for loss percentage
            # "x.x.x.x : xmt=4 rcv=4 loss=0%"
            parts = result.stdout.split()
            loss_idx = [i for i, x in enumerate(parts) if 'loss=' in x][0]
            loss_str = parts[loss_idx].split('=')[1]
            return float(loss_str.replace('%',''))
        except Exception:
            return 100.0 # Default to down

    def run_full_diagnostic(self, link):
        # 1. Mandatory ICMP Reachability
        gw_loss = self.ping_check(link.gateway_ip)
        if gw_loss >= 90:
            return {'status': 'CRITICAL', 'cause': 'Gateway Unreachable'}

        bts_loss = self.ping_check(link.bts_ip)
        client_loss = self.ping_check(link.client_ip)

        # 2. If Reachable, collect SNMP Metrics
        snmp_data = None
        if client_loss < 100:
            driver = get_driver(link)
            snmp_data = driver.get_radio_stats()

        # 3. Apply Logic Engine
        final_status = "UP"
        issues = []

        if client_loss == 100:
            final_status = "CRITICAL"
            issues.append("Client Unreachable")
        elif snmp_data:
            if snmp_data.get('rssi', 0) < -75:
                final_status = "DEGRADED"
                issues.append("Weak Signal")
            # Add Ethernet speed/duplex checks here via OIDs
            
        return {
            'link_id': link.id,
            'status': final_status,
            'ping_loss': {'gw': gw_loss, 'client': client_loss},
            'radio_data': snmp_data,
            'root_cause': issues
        }
        `,
        requirements: `
Flask==2.3.0
SQLAlchemy==2.0.0
mysqlclient==2.1.0
easysnmp==0.2.6
gunicorn==20.1.0
        `
    };

    function showCode(type) {
        document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        const display = document.getElementById('code-display');
        // Simple syntax highlighting mock
        let code = codeSnippets[type].replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // Very basic highlighter for demo
        code = code.replace(/(import|from|class|def|return|if|else|try|except)/g, '<span style="color:#c678dd">$1</span>');
        code = code.replace(/(#.*)/g, '<span style="color:#5c6370">$1</span>');
        code = code.replace(/('.*?')/g, '<span style="color:#98c379">$1</span>');
        
        display.innerHTML = `<pre><code>${code}</code></pre>`;
    }

    // Init
    window.onload = () => {
        renderTable();
        showCode('app');
    };

</script>

</body>
</html>
