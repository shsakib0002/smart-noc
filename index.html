<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmberIT NOC | Live Map & Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root { --bg: #0f111a; --panel: #1a1d2d; --accent: #3b82f6; --text: #e2e8f0; --ok: #10b981; --bad: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin:0; height:100vh; overflow:hidden; }
        
        /* MAIN UI */
        #app-ui { height:100%; display:flex; flex-direction:column; }
        header { background: #23273a; padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
        
        /* TABS */
        .tabs { display:flex; gap:20px; }
        .tab { cursor:pointer; opacity:0.7; padding-bottom:5px; }
        .tab.active { opacity:1; border-bottom:2px solid var(--accent); }

        /* VIEWS */
        .view { display:none; flex:1; overflow:hidden; }
        .view.active { display:block; }
        
        /* TABLE */
        .scroll-area { height:100%; overflow-y:auto; padding:20px; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:12px; text-align:left; border-bottom:1px solid #333; }
        tr:hover { background:rgba(255,255,255,0.05); }
        .badge { padding:3px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold; }
        .badge-UP { background:rgba(16,185,129,0.2); color:var(--ok); }
        .badge-DOWN { background:rgba(239,68,68,0.2); color:var(--bad); }

        /* TERMINAL PANEL */
        #term-panel { height:300px; background:#111; border-top:2px solid var(--accent); display:none; grid-template-columns: 300px 1fr; }
        .term-log { padding:15px; font-family:monospace; color:#0f0; overflow-y:auto; border-right:1px solid #333; font-size:0.9rem; }
        .term-viz { display:flex; align-items:center; justify-content:center; gap:20px; background:var(--panel); }
        
        /* HOP VISUALS */
        .hop { width:90px; height:90px; background:#222; border:2px solid #555; border-radius:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; }
        .hop.ok { border-color:var(--ok); box-shadow:0 0 10px rgba(16,185,129,0.2); }
        .hop.bad { border-color:var(--bad); box-shadow:0 0 10px rgba(239,68,68,0.3); }
        .line { width:50px; height:4px; background:#333; }
        .line.active { background:var(--ok); }
    </style>
</head>
<body>

    <div id="app-ui">
        <header>
            <div style="font-weight:bold; font-size:1.1rem;">AmberIT <span style="color:var(--accent)">NOC Core</span></div>
            <div class="tabs">
                <div class="tab active" onclick="setView('list')">List View</div>
                <div class="tab" onclick="setView('map')">Live Map</div>
            </div>
            <div style="font-size:0.8rem; color:#aaa">System Online</div>
        </header>

        <div id="view-list" class="view active">
            <div class="scroll-area">
                <table>
                    <thead><tr><th>ID</th><th>Name</th><th>POP</th><th>IP</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="table-body">
                         <tr><td colspan="6">Loading Inventory...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-map" class="view">
            <div id="map" style="width:100%; height:100%;"></div>
        </div>

        <div id="term-panel">
            <div class="term-log" id="term-log">Waiting...</div>
            <div class="term-viz" id="term-viz"></div>
        </div>
    </div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // ******************************************************
    // PASTE YOUR NGROK URL HERE (No trailing slash)
    const API_BASE = "https://alpha-nonstudious-traumatically.ngrok-free.dev"; 
    // ******************************************************

    let map = null;
    let inventory = [];

    // --- MAIN LOGIC ---
    async function loadInventory() {
        try {
            const res = await fetch(`${API_BASE}/api/inventory`);
            inventory = await res.json();
            renderTable();
        } catch (e) {
            document.getElementById('table-body').innerHTML = `<tr><td colspan="6" style="color:red">Connection Error. Check Ngrok/Backend.</td></tr>`;
        }
    }

    function renderTable() {
        const tb = document.getElementById('table-body');
        tb.innerHTML = '';
        inventory.forEach(item => {
            tb.innerHTML += `
                <tr>
                    <td>${item.id}</td>
                    <td><b>${item.name}</b></td>
                    <td>${item.pop}</td>
                    <td>${item.ip}</td>
                    <td><span class="badge badge-${item.status}">${item.status}</span></td>
                    <td><button onclick="runScan(${item.id}, '${item.name}')" style="background:var(--accent); color:white; border:none; padding:5px 10px; cursor:pointer;">Triple Scan</button></td>
                </tr>
            `;
        });
    }

    // --- TERMINAL VISUALIZER ---
    async function runScan(id, name) {
        const panel = document.getElementById('term-panel');
        const log = document.getElementById('term-log');
        const viz = document.getElementById('term-viz');
        
        panel.style.display = 'grid';
        log.innerHTML = `> INITIATING TRIPLE-HOP DIAGNOSTIC FOR: ${name}...\n`;
        viz.innerHTML = '<div style="color:#aaa">Pinging Nodes...</div>';

        try {
            const res = await fetch(`${API_BASE}/api/scan/${id}`, { method:'POST' });
            const data = await res.json();

            // LOG output
            log.innerHTML += `> --------------------------------\n`;
            data.hops.forEach(hop => {
                const ms = hop.status==='UP' ? hop.latency+'ms' : 'TIMEOUT';
                log.innerHTML += `> [${hop.label.toUpperCase()}] IP:${hop.ip} -> ${hop.status} (${ms})\n`;
            });
            log.innerHTML += `> --------------------------------\n`;
            log.innerHTML += `> FINAL STATUS: ${data.final_status}\n`;
            log.innerHTML += `> SIGNAL (RSSI): ${data.rssi} dBm\n`;

            // VISUAL output
            viz.innerHTML = '';
            data.hops.forEach((hop, idx) => {
                const color = hop.status === 'UP' ? 'ok' : (hop.status==='SKIP' ? '' : 'bad');
                viz.innerHTML += `
                    <div class="hop ${color}">
                        <div style="font-size:0.7rem; color:#aaa">${hop.label}</div>
                        <div style="font-weight:bold">${hop.ip}</div>
                        <div style="font-size:0.8rem">${hop.status}</div>
                    </div>
                `;
                if(idx < 2) {
                    viz.innerHTML += `<div class="line ${hop.status==='UP'?'active':''}"></div>`;
                }
            });

        } catch(e) {
            log.innerHTML += `> FATAL ERROR: Backend Connection Lost.`;
        }
    }

    // --- MAP VIEW ---
    function setView(v) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        event.target.classList.add('active');

        if(v === 'map' && !map) {
            map = L.map('map').setView([23.8103, 90.4125], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OSM', className: 'map-tiles'
            }).addTo(map);
            
            // Dark Mode Filter
            document.querySelector('.leaflet-layer').style.filter = "invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%)";

            // Add Markers
            inventory.forEach(i => {
                const lat = 23.8 + (Math.random() * 0.2 - 0.1);
                const lng = 90.4 + (Math.random() * 0.2 - 0.1);
                L.marker([lat, lng])
                 .addTo(map)
                 .bindPopup(`<b>${i.name}</b><br>Status: ${i.status}<br>IP: ${i.ip}`);
            });
        }
    }

    // Init
    loadInventory();
</script>
</body>
</html>
